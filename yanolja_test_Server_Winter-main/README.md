# yanolja_test_Server_Winter
2021-08-14 진행상황
1. 기획서 작성
2. aws를 이용한 서버 구축 (prod,dev 포함) dev= 3000 / prod=3001/test=3002 로 서버를 나눴다. (NODE_ENV=development node index.js
index.js 참고

2021-08-15 진행상황
1. erd설계 및 데이터베이스에 테이블 

2021-08-16 진행상황
1.로그인, 회원가입 api 생성 
2. 데이터베이스에 테스트데이터 삽입
3. api 리스트업

2021-08-17 진행상황

1. erd 설계 수정
2. 테스트데이터 수정 및 삽입 마무리
4. my야놀자 정보 조회 api 구현 중
7. 개발팀장님의 피드백
  1차: erd 컬럼 추가, 지역범위 지정시 도로명 주소 이용 추천
9. 개발 도중에 발생하는 이슈
  1. 어려운점: 같은 호텔의 같은 방에 딸린 옵션차이에 따라 가격에 차등이 있는 정보를 가격테이블에 저장하는 것이 어려웠다. 또 가격 테이블에서 모텔만 대실여부가 있는데 이를 isRent 로 대실/숙박에 따라 데이터를 하나하나 입력하는것이 맞게하는건가 싶었다. 
  2. 룸타입 테이블을 만들어 각 호텔과 방을 옵션에따라 한번 더 나눈뒤 룸타입 id 로 가격정보를 입력했다. 

2021-08-18 진행상황
템플릿다운부터 서버를 다시 구축하였다....
1. 서버 재구축, api 초기화된 것 재생성,
2. 쿼리 생성

2021-08-19 진행상황
1.쿼리생성 
2. 숙소리스트 조회 api 진행중

2021-08-20 진행상황
1.쿼리생성 - 장바구니리스트, 특정 숙소의 방 목록 조회 , 찜목록 조회 , 판매자 정보 조회 쿼리생성
2. 위 생성한 쿼리의 API 생성
3.  개발 도중에 발생하는 이슈
    3-1.쿼리를 짤 때, 방목록 조회와 장바구니 목록 조회에는 해당 방의 옵션에 따라 가격이 달라진다. 달라지는 가격을 요일별로 맞추는 작업도 어려웠지만 숙소리스트 조회와 찜 목록 조회 때 나오는 가격은 가장 싼 방의 가장 싼 가격이 뜨는데 이를 처리하는 것이 어려웠다. 두가지 모두 가장 싼 가격이 뜨도록 만들었다가 나중에야 깨닫고 수정하였다.
    3-2.방목록을 조회할 때, 숙소의 전체 이미지가 다 나오는데 이를 한줄로 처리하기 위해 쿼리를 짜는것도 어렵고 매우 길었다. 
    3-3. 위의 모든 조회를 할 때, 해당날짜에 예약된 정보가 있다면 가격칸에 '예약마감' 이라고 처리를 해야한다. 그래서 서브쿼리에서 요일마다 다른 가격이 나오도록 설정한후 메인 select 에서 
    해당 날짜에 예약된 정보가 있다면 (하루라도 겹친다면 )예약마감이라고 뜨게하고 아닐 경우 (하루도 안겹친다면 ) 서브쿼리에서 가져온 가격을 select 한다. 이렇게 조인을 많이 해보긴 처음이다 
    --> 해당 날짜에 예약된 정보의 유무 판별 : 
    (bi.status ='booked') && (예약 시작 날짜 > str_to_date(검색시작날짜, '%Y-%m-%d') || 예약 시작 날짜 >= str_to_date(검색끝날짜, '%Y-%m-%d'))
&&   (예약 끝 날짜<= str_to_date(검색시작날짜, '%Y-%m-%d') || 예약끝날짜 < str_to_date(검색끝날짜, '%Y-%m-%d')) 
                                  or if 예약된시작날짜,예약된끝날짜 is null -> 숙박가격 송출. else "예약마감"
                          이때 한 쪽만 = 를 붙인이유는, 예약이 끝나는 날에는 예약이 가능하기 때문이다. 

2021-08-21 진행상황
1.쿼리생성
2. api 3개 생성 
3. 쿠폰함의 남은 기간 계산하는 것이 어려웠다. 굉장히 복잡하게 생각했는데 막상 찾아보니 c언어 처음배울 때  배웠던 간단한 알고리즘이라 반성했다..  
  TIMESTAMPDIFF( day,now(),c.endDate),'일',
  TIMESTAMPDIFF( hour,now(),c.endDate) % 24,
  '시간',
  TIMESTAMPDIFF( hour,now(),c.endDate) %60,'분'
  
  2021-08-22 진행상황
1. 쿼리생성 - 프로시저를 사용하여 예약하기 구현에 편리함을 느꼈다 ,
2. 테스트데이터 사진 aws의 s3이용하여 삽입
3. 예약하기, 정보변경등 API 생성 
mysql 팁 - DAO 에서 ? 포함된 곳 -> like concat (“%”,?,”%”) or 변수 = "%" + 변수 +  "%"; 
이미지 concat하여 한줄로 출력 -> select GROUP_CONCAT( mu.menuImageUrl SEPARATOR ',') AS '이미지 주소'
                    from ( select * from table where ~~      limit concat할 개수 ) as img
               
  2021-08-23 진행상황
  1. 사진 S3로 업로드
  2. 탈퇴하기, 영수증 조회, 검색조회 등 API 생성

2021-08-24
1. 장바구니담기, 찜하기 등 API 생성
2. Dao 문 안에 변수로 여러 쿼리를 받아서 한번에 return 할 수 있다는 것을 테스트해봤다. 성공하니 매우 기쁘고 반면 한번에 되니 이게 맞나 싶었다. 그래도 이 방법을 알게돼서 당근마켓때 컨트롤러 혹은 provider부터 다 만들며 고생하던 때 보단 발전할 수 있었다.

2021-08-25
1. 당신의 취향저격 베스트 3 구현 
    찜리스트에 있는 숙소중 마지막으로 찜한(가장 최근에 찜한) 숙소와 인접하고 인기있는 숙소 3개 조회 
    먼저 인접한 숙소를 구하기 위해  substring_index(컬럼, 구분자, 인덱스) 를 사용하였다. 
    찜한 숙소의 주소를 가져와 공백을 기준으로 문자열을 추출하였다. 이는 곧 시, 구, 로 로 추출된다. 추출된 문자열과 전체 숙소들의 주소와 비교한다.(substring_index(찜한숙소주소, 구분자, 3) as 찜한숙소 로 & substring_index(숙소주소, 구분자, 3)) as 특정숙소로
    substring_index(숙소주소, 구분자, 3) 으로 '로'까지의 주소를 비교하여 같다면 3을 주고( ), 그 다움 구, 시로 비교할 지역은 넓어지되 값은 줄어든다. 
    찜한숙소 로 = 특정숙소로 라면, 4를 주고 차례대로 줄어들어 주소가 하나도 같지 않으면 1을 준다. 
    이 받은 값대로 정렬하여 인근숙소를 구한다. 
    그 다음, 찜된 개수를 조회하여 근접도가 같다면 찜된 개수가 많은 순으로 정렬한다. 
    
    
2021-08-26
1.네이버 sens 를 통해 문자 전송하여 번호인증 API 생성.
2. 예약하기, 결제하기 등의 쿼리 수정 --> 프로시저 if 문 내에서는 자바와 같이 비교가 안된다. 따라서 != 이 아닌 not like를 사용하여야한다.  예약하기를 진행하면서 처음에 프로시저 내 인              
    자 (userIDX ) 와 쿼리로 받는 값(USERID)를 userIDX!=USERID 면 에러메세지를 출력해야하는데 != 게 안되는줄 모르고 긴삽질을 했다.
    프로시저내에서 값을 비교할땐 비교연산자 말고 not like, like 를 쓰자..   또 업데이트 문에서 조건을 덜줘서 에러메세지가 뜨지만 예약은 돼서 아주 짜증나는 상황이 있었다. 조건은 언제나       
    최대로 줘야한다는 것을 또 깨달았다..
4. aquery tool 동기화  
5. 카카오 로그인 구현
